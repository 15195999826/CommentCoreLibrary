/*!Copyright(c) CommentCoreLibrary (//github.com/jabbany/CommentCoreLibrary) - Licensed under the MIT License */function CommentFilter(){this.modifiers=[],this.runtime=null,this.allowTypes={1:!0,4:!0,5:!0,6:!0,7:!0,8:!0,17:!0},this.doModify=function(a){for(var b=0;b<this.modifiers.length;b++)a=this.modifiers[b](a);return a},this.beforeSend=function(a){return a},this.doValidate=function(a){return this.allowTypes[a.mode]?!0:!1},this.addRule=function(){},this.addModifier=function(a){this.modifiers.push(a)},this.runtimeFilter=function(a){return null==this.runtime?a:this.runtime(a)},this.setRuntimeFilter=function(a){this.runtime=a}}function CommentManager(a){var b=0;this.stage=a,this.options={opacity:1,globalScale:1,scrollScale:1},this.timeline=[],this.runline=[],this.position=0,this.limiter=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new TopCommentSpaceAllocator(0,0),bottom:new BottomCommentSpaceAllocator(0,0),reverse:new ReverseCommentSpaceAllocator(0,0),scrollbtm:new BottomScrollCommentSpaceAllocator(0,0)},this.stage.width=this.stage.offsetWidth,this.stage.height=this.stage.offsetHeight,this.width=this.stage.width,this.height=this.stage.height,this.startTimer=function(){if(!(b>0)){var a=(new Date).getTime(),c=this;b=window.setInterval(function(){var b=(new Date).getTime()-a;a=(new Date).getTime(),c.onTimerEvent(b,c)},10)}},this.stopTimer=function(){window.clearInterval(b),b=0}}function AcfunParser(a){function b(a){for(;a.length<6;)a="0"+a;return a}var c=[];try{var d=JSON.parse(a)}catch(e){return console.log("Error: Could not parse json list!"),[]}for(var f=0;f<d.length;f++){var g={},h=d[f].c.split(",");if(h.length>0){if(g.stime=1e3*parseFloat(h[0]),g.color="#"+b(parseInt(h[1]).toString(16)),g.mode=parseInt(h[2]),g.size=parseInt(h[3]),g.hash=h[4],g.date=parseInt(h[5]),g.position="relative",7!=g.mode?(g.text=d[f].m.replace(/(\/n|\\n|\n|\r\n|\\r)/g,"\n"),g.text=g.text.replace(/\r/g,"\n"),g.text=g.text.replace(/\s/g," ")):g.text=d[f].m,7==g.mode){try{var i=JSON.parse(g.text)}catch(e){console.log("[Err] Error parsing internal data for comment"),console.log("[Dbg] "+g.text);continue}g.text=i.n,g.text=g.text.replace(/\ /g," "),console.log(g.text),null!=i.p?(g.x=i.p.x/1e3,g.y=i.p.y/1e3):(g.x=0,g.y=0),g.shadow=i.b,g.duration=4e3,null!=i.l&&(g.moveDelay=1e3*i.l),null!=i.z&&i.z.length>0&&(g.movable=!0,g.toX=i.z[0].x/1e3,g.toY=i.z[0].y/1e3,g.alphaTo=i.z[0].t,g.colorTo=i.z[0].c,g.moveDuration=null!=i.z[0].l?1e3*i.z[0].l:500,g.duration=g.moveDelay+g.moveDuration),null!=i.r&&null!=i.k&&(g.rX=i.r,g.rY=i.k),i.a&&(g.alphaFrom=i.a)}c.push(g)}}return c}function BilibiliParser(a,b,c){function d(a){return a.replace(/\t/,"\\t")}if(null!==a)var e=a.getElementsByTagName("d");else{if(c){if(!confirm("XML Parse Error. \n Allow tag soup parsing?\n[WARNING: This is unsafe.]"))return[]}else b=b.replace(new RegExp("</([^d])","g"),"</disabled $1"),b=b.replace(new RegExp("</(S{2,})","g"),"</disabled $1"),b=b.replace(new RegExp("<([^d/]W*?)","g"),"<disabled $1"),b=b.replace(new RegExp("<([^/ ]{2,}W*?)","g"),"<disabled $1"),console.log(b);var f=document.createElement("div");f.innerHTML=b,console.log(f);var e=f.getElementsByTagName("d")}for(var g=[],h=0;h<e.length;h++)if(null!=e[h].getAttribute("p")){var i=e[h].getAttribute("p").split(",");if(!e[h].childNodes[0])continue;var b=e[h].childNodes[0].nodeValue,j={};if(j.stime=Math.round(parseFloat(1e3*i[0])),j.size=parseInt(i[2]),j.color=parseInt(i[3]),j.mode=parseInt(i[1]),j.date=parseInt(i[4]),j.pool=parseInt(i[5]),j.position="absolute",null!=i[7]&&(j.dbid=parseInt(i[7])),j.hash=i[6],j.border=!1,j.mode<7)j.text=b.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==j.mode)try{adv=JSON.parse(d(b)),j.shadow=!0,j.x=parseInt(adv[0]),j.y=parseInt(adv[1]),j.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),j.rZ=0,j.rY=0,adv.length>=7&&(j.rZ=parseInt(adv[5]),j.rY=parseInt(adv[6])),j.movable=!1,adv.length>=11&&(j.movable=!0,j.toX=adv[7],j.toY=adv[8],j.moveDuration=500,j.moveDelay=0,""!=adv[9]&&(j.moveDuration=adv[9]),""!=adv[10]&&(j.moveDelay=adv[10]),adv.length>11&&(j.shadow=adv[11],"true"===j.shadow&&(j.shadow=!0),"false"===j.shadow&&(j.shadow=!1),null!=adv[12]&&(j.font=adv[12]))),j.duration=2500,adv[3]<12&&(j.duration=1e3*adv[3]),j.alphaFrom=1,j.alphaTo=1;var f=adv[2].split("-");null!=f&&f.length>1&&(j.alphaFrom=parseFloat(f[0]),j.alphaTo=parseFloat(f[1]))}catch(k){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+b)}else 8==j.mode&&(j.code=b);null!=j.text&&(j.text=j.text.replace(/\u25a0/g,"█")),g.push(j)}return g}Array.prototype.bsearch=function(a,b){if(0==this.length)return 0;if(b(a,this[0])<0)return 0;if(b(a,this[this.length-1])>=0)return this.length;for(var c=0,d=0,e=0,f=this.length-1;f>=c;){if(d=Math.floor((f+c+1)/2),e++,b(a,this[d-1])>=0&&b(a,this[d])<0)return d;b(a,this[d-1])<0?f=d-1:b(a,this[d])>=0?c=d:console.error("Program Error"),e>1500&&console.error("Too many run cycles.")}return-1},Array.prototype.binsert=function(a,b){this.splice(this.bsearch(a,b),0,a)};var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},CommentSpaceAllocator=function(){function a(a,b){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=0),this._pools=[[]],this.avoid=1,this._width=a,this._height=b}return a.prototype.willCollide=function(a,b){return a.stime+a.ttl>b.stime+b.ttl/2},a.prototype.pathCheck=function(a,b,c){for(var d=a+b.height,e=b.right,f=0;f<c.length;f++)if(!(c[f].y>d||c[f].bottom<a)){if(!(c[f].x<b.x||c[f].x>e))return!1;if(this.willCollide(c[f],b))return!1}return!0},a.prototype.assign=function(a,b){for(;this._pools.length<=b;)this._pools.push([]);var c=this._pools[b];if(0===c.length)return c.push(a),a.cindex=b,0;if(this.pathCheck(0,a,c))return a.cindex=b,c.binsert(a,function(a,b){return a.bottom<b.bottom?-1:a.bottom===b.bottom?0:1}),0;for(var d=0,e=0;e<c.length&&(d=c[e].bottom+this.avoid,!(d+a.height>this._height));e++)if(this.pathCheck(d,a,c))return a.cindex=b,c.binsert(a,function(a,b){return a.bottom<b.bottom?-1:a.bottom===b.bottom?0:1}),d;return this.assign(a,b+1)},a.prototype.add=function(a){a.height>this._height?(a.cindex=-2,a.y=0):a.y=this.assign(a,0)},a.prototype.remove=function(a){if(!(a.cindex<0)){var b=this._pools[a.cindex].indexOf(a);0>b||this._pools[a.cindex].splice(b,1)}},a.prototype.setBounds=function(a,b){this._width=a,this._height=b},a}(),TopCommentSpaceAllocator=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.add=function(b){a.prototype.add.call(this,b),b.x=(this._width-b.width)/2},b.prototype.willCollide=function(){return!0},b.prototype.pathCheck=function(a,b,c){for(var d=b.bottom,e=0;e<c.length;e++)if(!(c[e].y>d||c[e].bottom<a))return!1;return!0},b}(CommentSpaceAllocator),BottomCommentSpaceAllocator=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.add=function(b){b.align=2,b.invalidate(),a.prototype.add.call(this,b),b.x=(this._width-b.width)/2},b}(TopCommentSpaceAllocator),ReverseCommentSpaceAllocator=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.add=function(b){b.align=1,b.invalidate(),a.prototype.add.call(this,b)},b}(CommentSpaceAllocator),BottomScrollCommentSpaceAllocator=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.add=function(b){b.align=1,b.invalidate(),a.prototype.add.call(this,b)},b}(CommentSpaceAllocator),__extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},CoreComment=function(){function a(a,b){if("undefined"==typeof b&&(b={}),this.mode=1,this.stime=0,this.text="",this.ttl=4e3,this.dur=4e3,this.cindex=-1,this.motion=[],this.movable=!0,this.align=0,this._size=25,this._color=16777215,this._border=!1,this._alpha=1,this._shadow=!0,this._font="",!a)throw new Error("Comment not bound to comment manager.");if(this.parent=a,this.mode=b.hasOwnProperty("mode")?parseInt(b.mode,10):1,b.hasOwnProperty("dur")&&(this.dur=parseInt(b.dur,10),this.ttl=this.dur),this.dur*=this.parent.options.globalScale,this.ttl*=this.parent.options.globalScale,b.hasOwnProperty("text")&&(this.text=b.text),b.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[];for(var c=0;c<b.motion.length;c++){var d=0;for(var e in b.motion[c])d=Math.max(b.motion[c][e].dur,d)}}b.hasOwnProperty("color")&&(this._color=b.color),b.hasOwnProperty("size")&&(this._size=b.size),b.hasOwnProperty("border")&&(this._border=b.border),b.hasOwnProperty("opacity")&&(this._alpha=b.opacity),b.hasOwnProperty("font")&&(this._font=b.font)}return a.prototype.init=function(a){"undefined"==typeof a&&(a=null),this.dom=null!==a?a.dom:document.createElement("div"),this.dom.className="cmt",this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,""!==this._font&&(this.font=this._font)},Object.defineProperty(a.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this._x=this.align%2===0?this.dom.offsetLeft:this.parent.width-this.dom.offsetLeft-this.width),this._x},set:function(a){this._x=a,this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this._y=this.align<2?this.dom.offsetTop:this.parent.height-this.dom.offsetTop-this.height),this._y},set:function(a){this._y=a,this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(a){this._width=a,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(a){this._height=a,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"size",{get:function(){return this._size},set:function(a){this._size=a,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"color",{get:function(){return this._color},set:function(a){this._color=a;var b=a.toString(16);b=b.length>=6?b:new Array(6-b.length+1).join("0")+b,this.dom.style.color="#"+b,0===this._color&&(this.dom.className="cmt rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"alpha",{get:function(){return this._alpha},set:function(a){this._alpha=a,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"border",{get:function(){return this._border},set:function(a){this._border=a,this.dom.style.border=this._border?"1px solid #00ffff":"none"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"shadow",{get:function(){return this._shadow},set:function(a){this._shadow=a,this._shadow||(this.dom.className="cmt noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"font",{get:function(){return this._font},set:function(a){this._font=a,this.dom.style.fontFamily=this._font.length>0?this._font:""},enumerable:!0,configurable:!0}),a.prototype.time=function(a){this.ttl-=a,this.movable&&this.update(),this.ttl<=0&&this.finish()},a.prototype.update=function(){this.animate()},a.prototype.invalidate=function(){this._x=null,this._y=null},a.prototype.animate=function(){for(var a=0;a<this.motion.length;a++);},a.prototype.finish=function(){this.dom.parentElement.removeChild(this.dom),this.parent.finish(this)},a}(),ScrollComment=function(a){function b(b,c){a.call(this,b,c),this.dur*=this.parent.options.scrollScale,this.ttl*=this.parent.options.scrollScale}return __extends(b,a),b.prototype.init=function(b){"undefined"==typeof b&&(b=null),a.prototype.init.call(this,b),this.x=this.parent.width},b.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},b}(CoreComment);CommentManager.prototype.seek=function(a){this.position=this.timeline.bsearch(a,function(a,b){return a<b.stime?-1:a>b.stime?1:0})},CommentManager.prototype.validate=function(a){return null==a?!1:this.filter.doValidate(a)},CommentManager.prototype.load=function(a){this.timeline=a,this.timeline.sort(function(a,b){return a.stime>b.stime?2:a.stime<b.stime?-2:a.date>b.date?1:a.date<b.date?-1:null!=a.dbid&&null!=b.dbid?a.dbid>b.dbid?1:a.dbid<b.dbid?-1:0:0})},CommentManager.prototype.clear=function(){for(var a=0;a<this.runline.length;a++)this.finish(this.runline[a]),this.stage.removeChild(this.runline[a].dom);this.runline=[]},CommentManager.prototype.setBounds=function(){for(var a in this.csa)this.csa[a].setBounds(this.stage.offsetWidth,this.stage.offsetHeight);this.stage.width=this.stage.offsetWidth,this.stage.height=this.stage.offsetHeight,this.width=this.stage.width,this.height=this.stage.height,this.stage.style.perspective=this.stage.width*Math.tan(40*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.stage.width*Math.tan(40*Math.PI/180)/2+"px"},CommentManager.prototype.init=function(){this.setBounds(),null==this.filter&&(this.filter=new CommentFilter)},CommentManager.prototype.time=function(a){if(a-=1,this.position>=this.timeline.length||Math.abs(this.lastPos-a)>=2e3){if(this.seek(a),this.lastPos=a,this.timeline.length<=this.position)return}else this.lastPos=a;for(;this.position<this.timeline.length&&!(this.limiter>0&&this.runline.length>this.limiter)&&(this.validate(this.timeline[this.position])&&this.timeline[this.position].stime<=a);this.position++)this.sendComment(this.timeline[this.position])},CommentManager.prototype.rescale=function(){},CommentManager.prototype.sendComment=function(a){if(8===a.mode)return console.log(a),void(this.scripting&&console.log(this.scripting.eval(a.code)));if(null==this.filter||(a=this.filter.doModify(a),null!=a)){if(1===a.mode||2===a.mode||4===a.mode)var b=new ScrollComment(this,a);else var b=new CoreComment(this,a);if(b.init(),this.stage.appendChild(b.dom),null!=this.filter&&!this.filter.beforeSend(b))return this.stage.removeChild(b),void(b=null);switch(b.mode){default:case 1:this.csa.scroll.add(b);break;case 2:this.csa.scrollbtm.add(b);break;case 4:this.csa.bottom.add(b);break;case 5:this.csa.top.add(b);break;case 6:this.csa.reverse.add(b);break;case 17:case 7:if("relative"!==b.data.position?(b.style.top=b.data.y+"px",b.style.left=b.data.x+"px"):(b.style.top=b.data.y*this.stage.height+"px",b.style.left=b.data.x*this.stage.width+"px"),b.ttl=Math.round(a.duration*this.def.globalScale),b.dur=Math.round(a.duration*this.def.globalScale),0!==a.rY||0!==a.rZ){var c=function(a,b){for(var c=Math.PI/180,d=a*c,e=b*c,f=Math.cos,g=Math.sin,h=[f(d)*f(e),f(d)*g(e),g(d),0,-g(e),f(e),0,0,-g(d)*f(e),-g(d)*g(e),f(d),0,0,0,0,1],i=0;i<h.length;i++)Math.abs(h[i])<1e-6&&(h[i]=0);return"matrix3d("+h.join(",")+")"};b.style.transformOrigin="0% 0%",b.style.webkitTransformOrigin="0% 0%",b.style.OTransformOrigin="0% 0%",b.style.MozTransformOrigin="0% 0%",b.style.MSTransformOrigin="0% 0%",b.style.transform=c(a.rY,a.rZ),b.style.webkitTransform=c(a.rY,a.rZ),b.style.OTransform=c(a.rY,a.rZ),b.style.MozTransform=c(a.rY,a.rZ),b.style.MSTransform=c(a.rY,a.rZ)}}b.y=b.y,this.runline.push(b)}},CommentManager.prototype.finish=function(a){var b=this.runline.indexOf(a);switch(b>=0&&this.runline.splice(b,1),a.mode){default:case 1:this.csa.scroll.remove(a);break;case 2:this.csa.scrollbtm.remove(a);break;case 4:this.csa.bottom.remove(a);break;case 5:this.csa.top.remove(a);break;case 6:this.csa.reverse.remove(a);break;case 7:}},CommentManager.prototype.onTimerEvent=function(a,b){for(var c=0;c<b.runline.length;c++){var d=b.runline[c];d.hold||d.time(a)}};