/*!Copyright(c) CommentCoreLibrary v0.11.0 (//github.com/jabbany/CommentCoreLibrary) - Licensed under the MIT License */
var CommentManager=function(){function a(a){var b=0;this._listeners={},this._lastPosition=0,this.stage=a,this.options={global:{opacity:1,scale:1,className:"cmt"},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.limiter=0,this.factory=null,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this._startTimer=function(){if(!(b>0)){var a=(new Date).getTime(),c=this;b=window.setInterval(function(){var b=(new Date).getTime()-a;a=(new Date).getTime(),c.onTimerEvent(b,c)},10)}},this._stopTimer=function(){window.clearInterval(b),b=0}}var b=function(a,b){return a.stime>b.stime?2:a.stime<b.stime?-2:a.date>b.date?1:a.date<b.date?-1:null!=a.dbid&&null!=b.dbid?a.dbid>b.dbid?1:a.dbid<b.dbid?-1:0:0};return a.prototype.stop=function(){this._stopTimer(),this.runline.forEach(function(a){a.stop()})},a.prototype.start=function(){this._startTimer()},a.prototype.seek=function(a){this.position=BinArray.bsearch(this.timeline,a,function(a,b){return a<b.stime?-1:a>b.stime?1:0})},a.prototype.validate=function(a){return null!=a&&this.filter.doValidate(a)},a.prototype.load=function(a){this.timeline=a,this.timeline.sort(b),this.dispatchEvent("load")},a.prototype.insert=function(a){BinArray.binsert(this.timeline,a,b)<=this.position&&this.position++,this.dispatchEvent("insert")},a.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish();this.dispatchEvent("clear")},a.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.dispatchEvent("resize");for(var a in this.csa)this.csa[a].setBounds(this.width,this.height);this.stage.style.perspective=this.width/Math.tan(55*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.width/Math.tan(55*Math.PI/180)/2+"px"},a.prototype.init=function(a){if(this.setBounds(),null==this.filter&&(this.filter=new CommentFilter),null==this.factory)switch(a){case"legacy":this.factory=CommentFactory.defaultFactory();break;default:case"css":this.factory=CommentFactory.defaultCssRenderFactory()}},a.prototype.time=function(a){if(a-=1,this.position>=this.timeline.length||Math.abs(this._lastPosition-a)>=2e3){if(this.seek(a),this._lastPosition=a,this.timeline.length<=this.position)return}else this._lastPosition=a;for(;this.position<this.timeline.length&&this.timeline[this.position].stime<=a;this.position++)this.options.limit>0&&this.runline.length>this.limiter||this.validate(this.timeline[this.position])&&this.send(this.timeline[this.position])},a.prototype.rescale=function(){},a.prototype.send=function(a){if(8===a.mode)return console.log(a),void(this.scripting&&console.log(this.scripting.eval(a.code)));if(null==this.filter||null!=(a=this.filter.doModify(a))){var b=this.factory.create(this,a);switch(b.mode){default:case 1:this.csa.scroll.add(b);break;case 2:this.csa.scrollbtm.add(b);break;case 4:this.csa.bottom.add(b);break;case 5:this.csa.top.add(b);break;case 6:this.csa.reverse.add(b);break;case 7:case 17:}b.y=b.y,this.dispatchEvent("enterComment",b),this.runline.push(b)}},a.prototype.finish=function(a){this.dispatchEvent("exitComment",a),this.stage.removeChild(a.dom);var b=this.runline.indexOf(a);switch(b>=0&&this.runline.splice(b,1),a.mode){default:case 1:this.csa.scroll.remove(a);break;case 2:this.csa.scrollbtm.remove(a);break;case 4:this.csa.bottom.remove(a);break;case 5:this.csa.top.remove(a);break;case 6:this.csa.reverse.remove(a);break;case 7:}},a.prototype.addEventListener=function(a,b){void 0!==this._listeners[a]?this._listeners[a].push(b):this._listeners[a]=[b]},a.prototype.dispatchEvent=function(a,b){if(void 0!==this._listeners[a])for(var c=0;c<this._listeners[a].length;c++)try{this._listeners[a][c](b)}catch(a){console.err(a.stack)}},a.prototype.onTimerEvent=function(a,b){for(var c=0;c<b.runline.length;c++){b.runline[c].time(a)}},a}(),CommentFilter=function(){function a(b,c){for(var d=b.subject.split("."),e=c;d.length>0;){var f=d.shift();if(""!==f&&(e.hasOwnProperty(f)&&(e=e[f]),null===e||void 0===e)){e=null;break}}if(null===e)return!0;switch(b.op){case"<":return e<b.value;case">":return e>b.value;case"~":case"regexp":return new RegExp(b.value).test(e.toString());case"=":case"eq":return b.value===("number"==typeof e?e:e.toString());case"NOT":return!a(b.value,e);case"AND":return!!Array.isArray(b.value)&&b.value.every(function(b){return a(b,e)});case"OR":return!!Array.isArray(b.value)&&b.value.some(function(b){return a(b,e)});default:return!1}}function b(){this.rules=[],this.modifiers=[],this.allowUnknownTypes=!0,this.allowTypes={1:!0,2:!0,4:!0,5:!0,6:!0,7:!0,8:!0,17:!0}}return b.prototype.doModify=function(a){return this.modifiers.reduce(function(a,b){return b(a)},a)},b.prototype.beforeSend=function(a){return a},b.prototype.doValidate=function(b){return!((!this.allowUnknownTypes||b.mode.toString()in this.allowTypes)&&!this.allowTypes[b.mode.toString()])&&this.rules.every(function(c){try{var d=a(c,b)}catch(a){var d=!1}return"accept"===c.mode?d:!d})},b.prototype.addRule=function(a){if("accept"!==a.mode&&"reject"!==a.mode)throw new Error("Rule must be of accept type or reject type.");this.rules.push(a)},b.prototype.addModifier=function(a){if("function"!=typeof a)throw new Error("Modifiers need to be functions.");this.modifiers.push(a)},b}(),CommentProvider=function(){function a(){this._started=!1,this._destroyed=!1,this._staticSources={},this._dynamicSources={},this._parsers={},this._targets=[]}return a.SOURCE_JSON="JSON",a.SOURCE_XML="XML",a.SOURCE_TEXT="TEXT",a.BaseHttpProvider=function(a,b,c,d,e){return new Promise(function(f,g){var h=new XMLHttpRequest,i=b;if(d&&("POST"===a||"PUT"===a)){i+="?";var j=[];for(var k in d)d.hasOwnProperty(k)&&j.push(encodeURIComponent(k)+"="+encodeURIComponent(d[k]));i+=j.join("&")}h.responseType="string"==typeof c?c:"",h.onload=function(){this.status>=200&&this.status<300?f(this.response):g(new Error(this.status+" "+this.statusText))},h.onerror=function(){g(new Error(this.status+" "+this.statusText))},h.open(a,i),void 0!==e?h.send(e):h.send()})},a.JSONProvider=function(b,c,d,e){return a.BaseHttpProvider(b,c,"json",d,e).then(function(a){return a})},a.XMLProvider=function(b,c,d,e){return a.BaseHttpProvider(b,c,"document",d,e).then(function(a){return a})},a.TextProvider=function(b,c,d,e){return a.BaseHttpProvider(b,c,"text",d,e).then(function(a){return a})},a.prototype.addStaticSource=function(a,b){if(this._destroyed)throw new Error("Comment provider has been destroyed, cannot attach more sources.");return b in this._staticSources||(this._staticSources[b]=[]),this._staticSources[b].push(a),this},a.prototype.addDynamicSource=function(a,b){if(this._destroyed)throw new Error("Comment provider has been destroyed, cannot attach more sources.");return b in this._dynamicSources||(this._dynamicSources[b]=[]),this._dynamicSources[b].push(a),this},a.prototype.addTarget=function(a){if(this._destroyed)throw new Error("Comment provider has been destroyed, cannot attach more targets.");if(!(a instanceof CommentManager))throw new Error("Expected the target to be an instance of CommentManager.");return this._targets.push(a),this},a.prototype.addParser=function(a,b){if(this._destroyed)throw new Error("Comment provider has been destroyed, cannot attach more parsers.");return b in this._parsers||(this._parsers[b]=[]),this._parsers[b].unshift(a),this},a.prototype.applyParsersOne=function(a,b){return new Promise(function(c,d){if(!(b in this._parsers))return void d(new Error('No parsers defined for "'+b+'"'));for(var e=0;e<this._parsers[b].length;e++){var f=null;try{f=this._parsers[b][e].parseOne(a)}catch(a){console.error(a)}if(null!==f)return void c(f)}d(new Error("Ran out of parsers for they target type"))}.bind(this))},a.prototype.applyParsersList=function(a,b){return new Promise(function(c,d){if(!(b in this._parsers))return void d(new Error('No parsers defined for "'+b+'"'));for(var e=0;e<this._parsers[b].length;e++){var f=null;try{f=this._parsers[b][e].parseMany(a)}catch(a){console.error(a)}if(null!==f)return void c(f)}d(new Error("Ran out of parsers for the target type"))}.bind(this))},a.prototype.load=function(){if(this._destroyed)throw new Error("Cannot load sources on a destroyed provider.");var a=[];for(var b in this._staticSources)a.push(Promises.any(this._staticSources[b]).then(function(a){return this.applyParsersList(a,b)}.bind(this)));return 0===a.length?Promise.resolve([]):Promises.any(a).then(function(a){for(var b=0;b<this._targets.length;b++)this._targets[b].load(a);return Promise.resolve(a)}.bind(this))},a.prototype.start=function(){if(this._destroyed)throw new Error("Cannot start a provider that has been destroyed.");return this._started=!0,this.load().then(function(a){for(var b in this._dynamicSources)this._dynamicSources[b].forEach(function(a){a.addEventListener("receive",function(a){for(var c=0;c<this._targets.length;c++)this._targets[c].send(this.applyParserOne(a,b))}.bind(this))}.bind(this));return Promise.resolve(a)}.bind(this))},a.prototype.send=function(a,b){throw new Error("Not implemented")},a.prototype.destroy=function(){return this._destroyed?Promise.resolve():(this._destroyed=!0,Promise.resolve())},a}(),Promises=function(){var a={};return a.any=function(a){return Array.isArray(a)?0===a.length?Promise.reject():new Promise(function(b,c){for(var d=!1,e=0,f=[],g=0;g<a.length;g++)a[g].then(function(a){e++,d||(d=!0,b(a))}).catch(function(b){return function(g){e++,f[b]=g,e===a.length&&(d||c(f))}}(g))}):Promise.resolve(a)},a}(),BilibiliFormat=function(){var a={},b=function(a){return a.replace(/\t/,"\\t")},c=function(a){if("["!==a.charAt(0))return a;switch(a.charAt(a.length-1)){case"]":return a;case'"':return a+"]";case",":return a.substring(0,a.length-1)+'"]';default:return c(a.substring(0,a.length-1))}},d=function(a){return a=a.replace(new RegExp("</([^d])","g"),"</disabled $1"),a=a.replace(new RegExp("</(S{2,})","g"),"</disabled $1"),a=a.replace(new RegExp("<([^d/]W*?)","g"),"<disabled $1"),a=a.replace(new RegExp("<([^/ ]{2,}W*?)","g"),"<disabled $1")};return a.XMLParser=function(a){this._attemptFix=!0,this._logBadComments=!0,"object"==typeof a&&(this._attemptFix=!1!==a.attemptFix,this._logBadComments=!1!==a.logBadComments)},a.XMLParser.prototype.parseOne=function(a){try{var d=a.getAttribute("p").split(",")}catch(a){return null}var e=a.textContent,f={};if(f.stime=Math.round(1e3*parseFloat(d[0])),f.size=parseInt(d[2]),f.color=parseInt(d[3]),f.mode=parseInt(d[1]),f.date=parseInt(d[4]),f.pool=parseInt(d[5]),f.position="absolute",null!=d[7]&&(f.dbid=parseInt(d[7])),f.hash=d[6],f.border=!1,f.mode<7)f.text=e.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7===f.mode)try{this._attemptFix&&(e=b(c(e)));var g=JSON.parse(e);if(f.shadow=!0,f.x=parseFloat(g[0]),f.y=parseFloat(g[1]),(Math.floor(f.x)<f.x||Math.floor(f.y)<f.y)&&(f.position="relative"),f.text=g[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),f.rZ=0,f.rY=0,g.length>=7&&(f.rZ=parseInt(g[5],10),f.rY=parseInt(g[6],10)),f.motion=[],f.movable=!1,g.length>=11){f.movable=!0;var h=500,i={x:{from:f.x,to:parseFloat(g[7]),dur:h,delay:0},y:{from:f.y,to:parseFloat(g[8]),dur:h,delay:0}};if(""!==g[9]&&(h=parseInt(g[9],10),i.x.dur=h,i.y.dur=h),""!==g[10]&&(i.x.delay=parseInt(g[10],10),i.y.delay=parseInt(g[10],10)),g.length>11&&(f.shadow="false"!==g[11]&&!1!==g[11],null!=g[12]&&(f.font=g[12]),g.length>14)){"relative"===f.position&&(this._logBadComments&&console.warn("Cannot mix relative and absolute positioning!"),f.position="absolute");for(var j=g[14],k={x:i.x.from,y:i.y.from},l=[],m=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),n=j.split(/[a-zA-Z]/).length-1,o=m.exec(j);null!==o;){switch(o[1]){case"M":k.x=parseInt(o[2],10),k.y=parseInt(o[3],10);break;case"L":l.push({x:{from:k.x,to:parseInt(o[2],10),dur:h/n,delay:0},y:{from:k.y,to:parseInt(o[3],10),dur:h/n,delay:0}}),k.x=parseInt(o[2],10),k.y=parseInt(o[3],10)}o=m.exec(j)}i=null,f.motion=l}null!==i&&f.motion.push(i)}f.dur=2500,g[3]<12&&(f.dur=1e3*g[3]);var p=g[2].split("-");if(null!=p&&p.length>1){var q=parseFloat(p[0]),r=parseFloat(p[1]);f.opacity=q,q!==r&&(f.alpha={from:q,to:r})}}catch(a){this._logBadComments&&(console.warn("Error occurred in JSON parsing. Could not parse comment."),console.log("[DEBUG] "+e))}else 8===f.mode?f.code=e:this._logBadComments&&(console.warn("Unknown comment type : "+f.mode+". Not doing further parsing."),console.log("[DEBUG] "+e));return null!==f.text&&"string"==typeof f.text&&(f.text=f.text.replace(/\u25a0/g,"█")),f},a.XMLParser.prototype.parseMany=function(a){var b=[];try{b=a.getElementsByTagName("d")}catch(a){return null}for(var c=[],d=0;d<b.length;d++){var e=this.parseOne(b[d]);null!==e&&c.push(e)}return c},a.TextParser=function(b){this._allowInsecureDomParsing=!0,this._attemptEscaping=!0,this._canSecureNativeParse=!1,"object"==typeof b&&(this._allowInsecureDomParsing=!1!==b.allowInsecureDomParsing,this._attemptEscaping=!1!==b.attemptEscaping),"undefined"!=typeof document&&document&&document.createElement||(this._allowInsecureDomParsing=!1),"undefined"!=typeof DOMParser&&null!==DOMParser&&(this._canSecureNativeParse=!0),(this._allowInsecureDomParsing||this._canSecureNativeParse)&&(this._xmlParser=new a.XMLParser(b))},a.TextParser.prototype.parseOne=function(a){if(this._allowInsecureDomParsing){var b=a;this._attemptEscaping&&(b=d(b));var c=document.createElement("div");c.innerHTML=b;var e=c.getElementsByTagName("d");return 1!==e.length?null:this._xmlParser.parseOne(e[0])}if(this._canSecureNativeParse){var f=new DOMParser;return this._xmlParser.parseOne(f.parseFromString(a,"application/xml"))}throw new Error("Secure native js parsing not implemented yet.")},a.TextParser.prototype.parseMany=function(a){if(this._allowInsecureDomParsing){var b=a;this._attemptEscaping&&(b=d(b));var c=document.createElement("div");return c.innerHTML=b,this._xmlParser.parseMany(c)}if(this._canSecureNativeParse){var e=new DOMParser;return this._xmlParser.parseMany(e.parseFromString(a,"application/xml"))}throw new Error("Secure native js parsing not implemented yet.")},a}(),AcfunFormat=function(){var a={};return a.JSONParser=function(a){this._logBadComments=!0,this._logNotImplemented=!1,"object"==typeof a&&(this._logBadComments=!1!==a.logBadComments,this._logNotImplemented=!0===a.logNotImplemented)},a.JSONParser.prototype.parseOne=function(a){var b={};if("object"!=typeof a||null==a||!a.hasOwnProperty("c"))return null;var c=a.c.split(",");if(c.length>=6){if(b.stime=1e3*parseFloat(c[0]),b.color=parseInt(c[1]),b.mode=parseInt(c[2]),b.size=parseInt(c[3]),b.hash=c[4],b.date=parseInt(c[5]),b.position="absolute",7!==b.mode)b.text=a.m.replace(/(\/n|\\n|\n|\r\n|\\r)/g,"\n"),b.text=b.text.replace(/\r/g,"\n"),b.text=b.text.replace(/\s/g," ");else{try{var d=JSON.parse(a.m)}catch(a){return this._logBadComments&&(console.warn("Error parsing internal data for comment"),console.log("[Dbg] "+b.text)),null}if(b.position="relative",b.text=d.n,b.text=b.text.replace(/\ /g," "),"number"==typeof d.a?b.opacity=d.a:b.opacity=1,"object"==typeof d.p?(b.x=d.p.x/1e3,b.y=d.p.y/1e3):(b.x=0,b.y=0),"number"==typeof d.c)switch(d.c){case 0:b.align=0;break;case 2:b.align=1;break;case 6:b.align=2;break;case 8:b.align=3;break;default:this._logNotImplemented&&console.log("Cannot handle aligning to center! AlignMode="+d.c)}if(b.axis=0,b.shadow=d.b,b.dur=4e3,"number"==typeof d.l&&(b.dur=1e3*d.l),null!=d.z&&d.z.length>0){b.movable=!0,b.motion=[];for(var e=0,f={x:b.x,y:b.y,alpha:b.opacity,color:b.color},g=0;g<d.z.length;g++){var h=null!=d.z[g].l?1e3*d.z[g].l:500;e+=h;var i={};d.z[g].hasOwnProperty("rx")&&"number"==typeof d.z[g].rx&&this._logNotImplemented&&console.log("Encountered animated x-axis rotation. Ignoring."),d.z[g].hasOwnProperty("e")&&"number"==typeof d.z[g].e&&this._logNotImplemented&&console.log("Encountered animated y-axis rotation. Ignoring."),d.z[g].hasOwnProperty("d")&&"number"==typeof d.z[g].d&&this._logNotImplemented&&console.log("Encountered animated z-axis rotation. Ignoring."),d.z[g].hasOwnProperty("x")&&"number"==typeof d.z[g].x&&(i.x={from:f.x,to:d.z[g].x/1e3,dur:h,delay:0}),d.z[g].hasOwnProperty("y")&&"number"==typeof d.z[g].y&&(i.y={from:f.y,to:d.z[g].y/1e3,dur:h,delay:0}),f.x=i.hasOwnProperty("x")?i.x.to:f.x,f.y=i.hasOwnProperty("y")?i.y.to:f.y,d.z[g].hasOwnProperty("t")&&"number"==typeof d.z[g].t&&d.z[g].t!==f.alpha&&(i.alpha={from:f.alpha,to:d.z[g].t,dur:h,delay:0},f.alpha=i.alpha.to),d.z[g].hasOwnProperty("c")&&"number"==typeof d.z[g].c&&d.z[g].c!==f.color&&(i.color={from:f.color,to:d.z[g].c,dur:h,delay:0},f.color=i.color.to),b.motion.push(i)}b.dur=e+(b.moveDelay?b.moveDelay:0)}d.hasOwnProperty("w")&&(d.w.hasOwnProperty("f")&&(b.font=d.w.f),d.w.hasOwnProperty("l")&&Array.isArray(d.w.l)&&d.w.l.length>0&&this._logNotImplemented&&console.log("[Dbg] Filters not supported! "+JSON.stringify(d.w.l))),null!=d.r&&null!=d.k&&(b.rX=d.r,b.rY=d.k)}return b}return this._logBadComments&&(console.warn("Dropping this comment due to insufficient parameters. Got: "+c.length),console.log("[Dbg] "+a.c)),null},a.JSONParser.prototype.parseMany=function(a){if(!Array.isArray(a))return null;for(var b=[],c=0;c<a.length;c++){var d=this.parseOne(a[c]);null!==d&&b.push(d)}return b},a.TextParser=function(b){this._jsonParser=new a.JSONParser(b)},a.TextParser.prototype.parseOne=function(a){try{return this._jsonParser.parseOne(JSON.parse(a))}catch(a){return console.warn(a),null}},a.TextParser.prototype.parseMany=function(a){try{return this._jsonParser.parseMany(JSON.parse(a))}catch(a){return console.warn(a),null}},a}(),CommonDanmakuFormat=function(){var a={},b=function(a){return"number"==typeof a.mode&&"number"==typeof a.stime&&((8!==a.mode||"string"==typeof a.code)&&"string"==typeof a.text)};return a.JSONParser=function(){},a.JSONParser.prototype.parseOne=function(a){return b(a)?a:null},a.JSONParser.prototype.parseMany=function(a){return a.every(b)?a:null},a.XMLParser=function(){},a.XMLParser.prototype.parseOne=function(a){var b={};try{b.stime=parseInt(a.getAttribute("stime")),b.mode=parseInt(a.getAttribute("mode")),b.size=parseInt(a.getAttribute("size")),b.color=parseInt(a.getAttribute("color")),b.text=a.textContent}catch(a){return null}return b},a.XMLParser.prototype.parseMany=function(a){try{var b=a.getElementsByTagName("comment")}catch(a){return null}for(var c=[],d=0;d<b.length;d++){var e=this.parseOne(b[d]);null!==e&&c.push(e)}return c},a}();